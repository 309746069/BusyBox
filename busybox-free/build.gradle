import java.text.SimpleDateFormat

buildscript {
  repositories {
    maven { url 'https://maven.fabric.io/public' }
  }

  dependencies {
    classpath 'io.fabric.tools:gradle:1.21.7'
  }
}

apply plugin: 'com.android.application'
apply plugin: 'io.fabric'

repositories {
  maven { url 'https://maven.fabric.io/public' }
}

def versionMajor = 5
def versionMinor = 5
def versionPatch = 1
def versionBuild = 0
def versionSuffix = versionBuild > 0 ? "-beta" : ""

def initCrashlyticsPropertiesIfNeeded() {
  def propertiesFile = file('fabric.properties')
  if (!propertiesFile.exists()) {
    def commentMessage = "This is autogenerated crashlytics property from system environment to prevent key to be committed to source control."
    ant.propertyfile(file: "fabric.properties", comment: commentMessage) {
      entry(key: "apiSecret", value: FABRIC_API_SECRET)
      entry(key: "apiKey", value: FABRIC_API_KEY)
    }
  }
}

def gitSha() {
  return "git --git-dir=${projectDir}/../.git --work-tree=${projectDir}/.. rev-parse --short HEAD".execute().text.trim()
}

def buildTime() {
  def df = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm'Z'")
  df.setTimeZone(TimeZone.getTimeZone("UTC"))
  return df.format(new Date())
}

android {
  compileSdkVersion 24
  buildToolsVersion "24.0.2"

  defaultConfig {
    applicationId "com.jrummy.busybox.installer"
    minSdkVersion 14
    targetSdkVersion 24
    //noinspection GroovyAssignabilityCheck
    versionCode versionMajor * 10000 + versionMinor * 1000 + versionPatch * 100 + versionBuild
    versionName "${versionMajor}.${versionMinor}.${versionPatch}.${versionBuild}${versionSuffix}"
    buildConfigField "String", "GIT_SHA", "\"${gitSha()}\""
    buildConfigField "String", "BUILD_TIME", "\"${buildTime()}\""
  }
  signingConfigs {
    release {
      storeFile file(KEYSTORE_FILE)
      storePassword KEYSTORE_PASSWORD
      keyAlias KEYSTORE_ALIAS
      keyPassword KEYSTORE_PASSWORD
    }
  }
  buildTypes {
    release {
      minifyEnabled true
      shrinkResources true
      proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
      signingConfig signingConfigs.release
      applicationVariants.all { variant ->
        variant.outputs.each { output ->
          //noinspection GroovyAssignabilityCheck
          output.outputFile = new File(output.outputFile.parent,
              output.outputFile.name.replace(
                  "busybox-free-release.apk", "BusyBox-Free-v" + versionName + "-release.apk"))
        }
      }
    }
  }
}

dependencies {
  compile 'com.google.firebase:firebase-ads:9.4.0'
  compile 'com.anjlab.android.iab.v3:library:1.0.32'
  testCompile 'junit:junit:4.12'
  compile project(':busybox-installer')
}

afterEvaluate {
  initCrashlyticsPropertiesIfNeeded()
}
